{% extends 'layout.twig' %}
{% block content %}
	<div id="app">
		<form method="POST" action="{{ root }}/institucion/guardar" id="form-edit-cliente" class="form-horizontal"
		      autocomplete="off" enctype="multipart/form-data">
			<div class="card">
				<div class="card-header">
					<h4 class="card-title">CLIENTE</h4>
				</div>
				<div class="card-body">
					<div class=" row mb-4">
						<label for="inputName" class="col-md-2 form-label">Nombres *</label>
						<div class="col-md-4 col-informacion">
							<input type="text" readonly class="form-control-plaintext" v-model="cliente.nombres">
						</div>

						<label for="inputName" class="col-md-2 form-label">Cédula *</label>
						<div class="col-md-4 col-informacion">
							<input type="text" readonly class="form-control-plaintext" v-model="cliente.cedula">
						</div>
					</div>

					<div class=" row mb-4">
						<label for="inputName" class="col-md-2 form-label">Teléfonos</label>
						<div class="col-md-10">
							<table class="table border text-nowrap text-md-nowrap table-bordered table-sm mb-0">
								<thead>
								<tr>
									<th>Número Oro</th>
									<th>Tipo</th>
									<th>Descripción</th>
									<th>Teléfono</th>
									<th>Origen</th>
								</tr>
								</thead>
								<tbody>
								<tr v-for="t in telefono">
									<td>
										<label class="custom-control custom-radio">
											<input type="radio" class="custom-control-input" name="example-radios"
											       value="option1" checked>
											<span class="custom-control-label"></span>
										</label>
									</td>
									<td>
										<span style="text-transform: uppercase;" class="form-control-plaintext" v-html="t.tipo"></span>
									</td>
									<td>
										<span style="text-transform: uppercase;" class="form-control-plaintext" v-html="t.descripcion"></span>
									</td>
									<td>
										<span style="text-transform: uppercase;" class="form-control-plaintext" v-html="t.telefono"></span>
									</td>
									<td>
										<span style="text-transform: uppercase;" class="form-control-plaintext" v-html="t.origen"></span>
									</td>
								</tr>
								</tbody>
							</table>
						</div>
					</div>

					<div class=" row mb-4">
						<label for="inputName" class="col-md-2 form-label">Direcciones</label>
						<div class="col-md-10">
							<table class="table border table-bordered table-sm mb-0">
								<thead>
								<tr>
									<th>Tipo</th>
									<th>Ciudad</th>
									<th>Dirección</th>
								</tr>
								</thead>
								<tbody>
								<tr v-for="d in direccion">
									<td>
										<span style="text-transform: uppercase;" class="form-control-plaintext" v-html="d.tipo"></span>
									</td>
									<td>
										<span style="text-transform: uppercase;" class="form-control-plaintext" v-html="d.ciudad"></span>
									</td>
									<td>
										<span style="text-transform: uppercase;" class="form-control-plaintext" v-html="d.direccion"></span>
									</td>
								</tr>
								</tbody>
							</table>
						</div>
					</div>

					<div class=" row mb-4">
						<label for="inputName" class="col-md-2 form-label">Emails</label>
						<div class="col-md-10">
							<table class="table border text-nowrap text-md-nowrap table-bordered table-sm mb-0">
								<thead>
								<tr>
									<th>Tipo</th>
									<th>Descripción</th>
									<th>Email</th>
									<th>Origen</th>
								</tr>
								</thead>
								<tbody>
								<tr v-for="e in email">
									<td>
										<span style="text-transform: uppercase;" class="form-control-plaintext" v-html="e.tipo"></span>
									</td>
									<td>
										<span style="text-transform: uppercase;" class="form-control-plaintext" v-html="e.descripcion"></span>
									</td>
									<td>
										<span style="text-transform: uppercase;" class="form-control-plaintext" v-html="e.email"></span>
									</td>
									<td>
										<span style="text-transform: uppercase;" class="form-control-plaintext" v-html="e.origen"></span>
									</td>
								</tr>
								</tbody>
							</table>
						</div>
					</div>

					<div class=" row mb-4">
						<label for="inputName" class="col-md-2 form-label">Referencias</label>
						<div class="col-md-10">
							<table class="table border text-nowrap text-md-nowrap table-bordered table-sm mb-0">
								<thead>
								<tr>
									<th>Tipo</th>
									<th>Descripción</th>
									<th>Nombre</th>
									<th>Teléfono</th>
									<th>Ciudad</th>
									<th>Dirección</th>
								</tr>
								</thead>
								<tbody>
								<tr v-for="r in referencia">
									<td>
										<input type="text" style="text-transform: uppercase;" readonly
										       class="form-control-plaintext" v-model="r.tipo">
									</td>
									<td>
										<input type="text" style="text-transform: uppercase;" readonly
										       class="form-control-plaintext" v-model="r.descripcion">
									</td>
									<td>
										<input type="text" style="text-transform: uppercase;" readonly
										       class="form-control-plaintext" v-model="r.nombre">
									</td>
									<td>
										<input type="text" style="text-transform: uppercase;" readonly
										       class="form-control-plaintext" v-model="r.telefono">
									</td>
									<td>
										<input type="text" style="text-transform: uppercase;" readonly
										       class="form-control-plaintext" v-model="r.ciudad">
									</td>
									<td>
											<textarea rows="3" v-model="r.direccion" class="form-control-plaintext"
											          readonly placeholder="Dirección" v-autoname></textarea>
									</td>
								</tr>
								</tbody>
							</table>
						</div>
					</div>

					<div class="mb-0 mt-4 ">
						<div class="col-md-12">
							<input type="hidden" v-model="model.id" id="id" name="id"/>
						</div>
					</div>
				</div>
			</div>
		</form>

		<form method="POST" action="{{ root }}/producto/guardarSeguimiento" id="form-edit-seguimiento" class="form-horizontal" autocomplete="off" enctype="multipart/form-data">
			<div class="card">
				<div class="card-header">
					<h4 class="card-title">SEGUIMIENTO</h4>
				</div>
				<div class="card-body">
					<div class=" row mb-4">
						<label for="inputName" class="col-md-2 form-label">{{ paleta.titulo_nivel1 }}</label>
						<div class="col-md-4 col-informacion">
							<select class="form-control form-select select2" v-on:change="cargarNivel2"
							        v-model="seguimiento.nivel_1_id" placeholder="Seleccione una opción" id="nivel_1_id"
							        required v-autoname>
								<option v-for="(v,k) in cat.paleta_nivel_1" v-html="v" :value="k"></option>
							</select>
						</div>

						<label for="inputName" class="col-md-2 form-label">{{ paleta.titulo_nivel2 }}</label>
						<div class="col-md-4 col-informacion">
							<select class="form-control form-select select2" v-on:change="cargarNivel3"
							        v-model="seguimiento.nivel_2_id" placeholder="Seleccione una opción" id="nivel_2_id"
							        required v-autoname>
								<option v-for="(v,k) in cat.paleta_nivel_2" v-html="v" :value="k"></option>
							</select>
						</div>
					</div>

					<h4 class="text-primary">MOTIVO DE NO PAGO</h4>
					<div class=" row mb-4">
						<label for="inputName" class="col-md-2 form-label">Motivo No Pago</label>
						<div class="col-md-4 col-informacion">
							<select class="form-control form-select select2" v-on:change="cargarMotivoNoPagoNivel2"
							        v-model="seguimiento.nivel_1_motivo_no_pago_id" placeholder="Seleccione una opción" id="nivel_1_motivo_no_pago_id"
							        required v-autoname>
								<option v-for="(v,k) in cat.paleta_motivo_no_pago_nivel_1" v-html="v" :value="k"></option>
							</select>
						</div>
					</div>

					<hr/>
					<div class=" row mb-4">
						<label for="inputName" class="col-md-2 form-label">Observaciones</label>
						<div class="col-md-4 col-informacion">
						<textarea rows="3" class="form-control" placeholder="Observaciones"
						          v-model="seguimiento.observaciones" v-autoname></textarea>
						</div>
					</div>

					<div class="mb-0 mt-4 ">
						<div class="col-md-12">
							<input type="hidden" name="json" id="json"/>
							<button class="btn btn-primary" type="submit" id="btnGuardar" name="btnGuardar">
								<i class="fa fa-save"></i> GUARDAR
							</button>
						</div>
					</div>
				</div>
			</div>
		</form>

		<div class="card">
			<div class="card-header">
				<h4 class="card-title">PRODUCTO</h4>
			</div>
			<div class="card-body">
				<div class=" row mb-4">
					<label for="inputName" class="col-md-2 form-label">Código operación</label>
					<div class="col-md-4 col-informacion">
						<span class="form-control-plaintext" style="text-transform: uppercase;" v-html="model.producto"></span>
					</div>

					<label for="inputName" class="col-md-2 form-label">Estado</label>
					<div class="col-md-4 col-informacion">
						<span class="form-control-plaintext" style="text-transform: uppercase;" v-html="model.estado"></span>
					</div>
				</div>

				{% set residuo_final = 1 %}
				{% for key, pc in producto_campos %}
					{% if((key % 2) == 0) %}
						<div class=" row mb-4">
					{% endif %}
					<label for="inputName" class="col-md-2 form-label">{{ pc.campo }}</label>
					<div class="col-md-4 col-informacion">
						<span class="form-control-plaintext">{{ pc.valor }}</span>
					</div>
					{% if((key % 2) == 1) %}
						</div>
					{% endif %}
					{% set residuo_final = (key % 2) %}
				{% endfor %}
				{% if(residuo_final == 0) %}
			</div>
			{% endif %}
		</div>
	</div>

	{{ bundle('validate') }}
	{{ bundle('summer') }}
	{{ script('js/lodash.js') }}
	{{ bundle('jasny') }}
	<script>
        _autonameVueCount = 0;
        Vue.directive('autoname', {
            inserted: function (el, binding, vnode) {
                _autonameVueCount++;
                $(el).prop('name', '_auto' + _autonameVueCount);
            }
        });

        var app = new Vue({
            el: '#app',
            data: {
                cat: {{ catalogos|raw }},
                model: {{ model|raw }},
                telefono: {{ telefono|raw }},
	            email: {{ email|raw }},
                direccion: {{ direccion|raw }},
                referencia: {{ referencia|raw }},
                cliente: {{ cliente|raw }},
                pagos: {{ pagos|raw }},
                aplicativo_diners: {{ aplicativo_diners|raw }},
                aplicativo_diners_tarjeta_diners: {{ aplicativo_diners_tarjeta_diners|raw }},
                aplicativo_diners_tarjeta_discover: {{ aplicativo_diners_tarjeta_discover|raw }},
                aplicativo_diners_tarjeta_interdin: {{ aplicativo_diners_tarjeta_interdin|raw }},
                aplicativo_diners_tarjeta_mastercard: {{ aplicativo_diners_tarjeta_mastercard|raw }},
                aplicativo_diners_porcentaje_interes: {{ aplicativo_diners_porcentaje_interes|raw }},
                seguimiento: {{ seguimiento|raw }},
            },
            watch: {},
            computed: {},
            methods: {
                cargarNivel2: function () {
                    var self = this;
                    var data = {
                        nivel_1_id: self.seguimiento.nivel_1_id,
                    };
                    $.post('{{ root }}/paleta/cargarNivel2', data, function (res) {
                        self.cat.paleta_nivel_2 = res;
                        console.log(res);
                    });
                },

                cargarNivel3: function () {
                    var self = this;
                    var data = {
                        nivel_2_id: self.seguimiento.nivel_2_id,
                    };
                    $.post('{{ root }}/paleta/cargarNivel3', data, function (res) {
                        self.cat.paleta_nivel_3 = res;
                        console.log(res);
                    });
                },

                cargarNivel4: function () {
                    var self = this;
                    var data = {
                        nivel_3_id: self.seguimiento.nivel_3_id,
                    };
                    $.post('{{ root }}/paleta/cargarNivel4', data, function (res) {
                        self.cat.paleta_nivel_4 = res;
                        console.log(res);
                    });
                },

                cargarMotivoNoPagoNivel2: function () {
                    var self = this;
                    var data = {
                        nivel_1_motivo_no_pago_id: self.seguimiento.nivel_1_motivo_no_pago_id,
                    };
                    $.post('{{ root }}/paleta/cargarMotivoNoPagoNivel2', data, function (res) {
                        self.cat.paleta_motivo_no_pago_nivel_2 = res;
                        console.log(res);
                    });
                },

                calcularValoresDiners: function () {
                    var self = this;
                    var data = {
                        data: self.aplicativo_diners_tarjeta_diners,
                        aplicativo_diners_id: self.aplicativo_diners.id,
                    };
                    // self.aplicativo_diners_tarjeta_diners = [];
                    $.post('{{ root }}/producto/calcularTarjetaDiners', data, function (res) {
                        self.aplicativo_diners_tarjeta_diners = res;
                        // console.log(self.aplicativo_diners_tarjeta_diners);
                        //ALERTAS
                        if (parseFloat(self.aplicativo_diners_tarjeta_diners.abono_total) < parseFloat(self.aplicativo_diners_tarjeta_diners.interes_facturado)) {
                            $("#alerta_abono_diners").show();
                        } else {
                            $("#alerta_abono_diners").hide();
                        }
                    });
                },

                calcularValoresInterdin: function () {
                    var self = this;
                    var data = {
                        data: self.aplicativo_diners_tarjeta_interdin,
                        aplicativo_diners_id: self.aplicativo_diners.id,
                    };
                    // self.aplicativo_diners_tarjeta_interdin = [];
                    $.post('{{ root }}/producto/calculosTarjetaGeneral', data, function (res) {
                        self.aplicativo_diners_tarjeta_interdin = res;
                        //ALERTAS
                        if (parseFloat(self.aplicativo_diners_tarjeta_interdin.abono_total) < parseFloat(self.aplicativo_diners_tarjeta_interdin.interes_facturado)) {
                            $("#alerta_abono_interdin").show();
                        } else {
                            $("#alerta_abono_interdin").hide();
                        }
                    });
                },

                calcularValoresDiscover: function () {
                    var self = this;
                    var data = {
                        data: self.aplicativo_diners_tarjeta_discover,
                        aplicativo_diners_id: self.aplicativo_diners.id,
                    };
                    // self.aplicativo_diners_tarjeta_discover = [];
                    $.post('{{ root }}/producto/calculosTarjetaGeneral', data, function (res) {
                        self.aplicativo_diners_tarjeta_discover = res;
                        //ALERTAS
                        if (parseFloat(self.aplicativo_diners_tarjeta_discover.abono_total) < parseFloat(self.aplicativo_diners_tarjeta_discover.interes_facturado)) {
                            $("#alerta_abono_discover").show();
                        } else {
                            $("#alerta_abono_discover").hide();
                        }
                    });
                },

                calcularValoresMastercard: function () {
                    var self = this;
                    var data = {
                        data: self.aplicativo_diners_tarjeta_mastercard,
                        aplicativo_diners_id: self.aplicativo_diners.id,
                    };
                    // self.aplicativo_diners_tarjeta_mastercard = [];
                    $.post('{{ root }}/producto/calculosTarjetaGeneral', data, function (res) {
                        self.aplicativo_diners_tarjeta_mastercard = res;
                        //ALERTAS
                        if (parseFloat(self.aplicativo_diners_tarjeta_mastercard.abono_total) < parseFloat(self.aplicativo_diners_tarjeta_mastercard.interes_facturado)) {
                            $("#alerta_abono_mastercard").show();
                        } else {
                            $("#alerta_abono_mastercard").hide();
                        }
                    });
                },
            },
            mounted: function () {
                var self = this;

                if(self.aplicativo_diners_tarjeta_diners.length != 0){
                    self.calcularValoresDiners();
                }
                if(self.aplicativo_diners_tarjeta_discover.length != 0){
                    self.calcularValoresDiscover();
                }
                if(self.aplicativo_diners_tarjeta_interdin.length != 0){
                    self.calcularValoresInterdin();
                }
                if(self.aplicativo_diners_tarjeta_mastercard.length != 0){
                    self.calcularValoresMastercard();
                }

                $("#alerta_abono_diners").hide();
                $("#alerta_abono_interdin").hide();
                $("#alerta_abono_discover").hide();
                $("#alerta_abono_mastercard").hide();
                $('#form-edit-seguimiento').validate({
                    onfocusout: false,
                    onkeyup: false,
                    onclick: false,
                    submitHandler: function (form) {
                        var data = {
                            model: self.model,
                            seguimiento: self.seguimiento,
                            aplicativo_diners: self.aplicativo_diners,
                            aplicativo_diners_tarjeta_diners: self.aplicativo_diners_tarjeta_diners,
                            aplicativo_diners_tarjeta_discover: self.aplicativo_diners_tarjeta_discover,
                            aplicativo_diners_tarjeta_mastercard: self.aplicativo_diners_tarjeta_mastercard,
                            aplicativo_diners_tarjeta_interdin: self.aplicativo_diners_tarjeta_interdin,
                        };
                        $('#json').val(JSON.stringify(data));
                        $("#btnGuardar").prop("disabled", true);
                        form.submit();
                        return false;
                    }
                });
                $('#btnExportarNegociacionManual').click(function () {
                    var data = {
                        model: self.model,
                        aplicativo_diners: self.aplicativo_diners,
                        aplicativo_diners_tarjeta_diners: self.aplicativo_diners_tarjeta_diners,
                        aplicativo_diners_tarjeta_discover: self.aplicativo_diners_tarjeta_discover,
                        aplicativo_diners_tarjeta_mastercard: self.aplicativo_diners_tarjeta_mastercard,
                        aplicativo_diners_tarjeta_interdin: self.aplicativo_diners_tarjeta_interdin,
                    };
                    $('#jsonNegociacionManual').val(JSON.stringify(data));
                    $('#exportFormNegociacionManual').submit();
                });
                $('#btnExportarNegociacionAutomatica').click(function () {
                    var data = {
                        model: self.model,
                        aplicativo_diners: self.aplicativo_diners,
                        aplicativo_diners_tarjeta_diners: self.aplicativo_diners_tarjeta_diners,
                        aplicativo_diners_tarjeta_discover: self.aplicativo_diners_tarjeta_discover,
                        aplicativo_diners_tarjeta_mastercard: self.aplicativo_diners_tarjeta_mastercard,
                        aplicativo_diners_tarjeta_interdin: self.aplicativo_diners_tarjeta_interdin,
                    };
                    $('#jsonNegociacionAutomatica').val(JSON.stringify(data));
                    $('#exportFormNegociacionAutomatica').submit();
                });
            }
        });
	</script>
	<style>
        table, th, td {
            border: 1px solid;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }
	</style>
{% endblock %}